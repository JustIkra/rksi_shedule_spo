# Спецификация: Портал плана мероприятий СПО Ростовской области

## 1. Обзор проекта

### 1.1 Назначение
Веб-приложение для отображения и редактирования плана мероприятий Совета директоров СПО Ростовской области на 2026 год. Позволяет просматривать мероприятия по месяцам, загружать фотографии, добавлять пояснения и ссылки на публикации.

### 1.2 Целевая аудитория
- **Пользователи**: сотрудники колледжей и техникумов Ростовской области (только внутренние)
- **Администратор**: 1 человек с полным доступом

### 1.3 Источник данных
Excel-файл `ПЛАН_РАБОТЫ_2026_по_месяцам_проверено_доп_поля.xlsx`:
- 12 листов (по месяцам: Январь — Декабрь)
- 8 колонок: № п/п, Наименование мероприятия, Дата проведения, Ответственные, Место проведения, Пояснение, Ссылки, Фотографии
- Категории мероприятий (Заседания Президиума, Олимпиады, Конкурсы и т.д.)
- Подкатегории внутри некоторых таблиц (например, "05.00.00 Науки о Земле") — отображаются как визуальные разделители

### 1.4 Домен
- **Продакшен**: `events.labs-edu.ru`
- **CORS**: настраивается через переменную окружения

---

## 2. Модель доступа

### 2.1 Публичная часть (единый пароль)
- Вход по единому паролю для всех пользователей
- Сессия сохраняется **30 дней**
- Пароль меняется администратором через админ-панель

### 2.2 Права обычных пользователей (после ввода пароля)
- Просмотр всех мероприятий
- Редактирование 3 полей: **Пояснение**, **Ссылки**, **Фотографии**
- Загрузка фотографий
- Удаление любых фотографий (с диалогом подтверждения)
- Скачивание фотографий

### 2.3 Админ-панель
- Доступ: `/admin` + **отдельный пароль**
- Полное редактирование всех полей мероприятий
- Добавление/удаление мероприятий
- **Добавление/редактирование/удаление категорий**
- Импорт Excel
- Экспорт в Excel
- Изменение пароля публичной части

---

## 3. Функциональные требования

### 3.1 Публичная часть

#### 3.1.1 Страница входа
- Поле ввода пароля
- Кнопка "Войти"
- Сообщение об ошибке при неверном пароле
- Запоминание сессии на 30 дней

#### 3.1.2 Главная страница (список мероприятий)
- **Навигация**: 12 табов сверху (Январь — Декабрь), включая пустые месяцы
- **Месяц по умолчанию**: текущий месяц (автоопределение)
- **Пустые месяцы**: показывают сообщение "Мероприятий нет"
- **Группировка**: по категориям мероприятий (как в Excel)
- **Подкатегории**: визуальные разделители в таблице (одноуровневая структура)
- **Категории сворачиваемые**: можно скрыть/показать группу
- **Таблица мероприятий** с колонками:
  - № п/п
  - Наименование мероприятия
  - Дата проведения
  - Ответственные за подготовку
  - Место проведения
  - Пояснение (редактируемое)
  - Ссылки на материалы (редактируемое)
  - Фотографии (миниатюры + кнопка загрузки)

#### 3.1.3 Редактирование полей (inline)
- **Пояснение**: клик на ячейку → появляется textarea для редактирования
- **Ссылки**: неограниченное количество URL, добавление/удаление
  - Формат: только URL (без названия)
  - Валидация: без валидации (пользователь отвечает за правильность)
- Автосохранение при потере фокуса
- **Конфликты**: последний сохранивший перезаписывает данные

#### 3.1.4 Работа с фотографиями

**Загрузка:**
- Мультизагрузка (несколько файлов сразу)
- Drag & Drop + кнопка выбора файлов
- Форматы: **только JPEG, PNG** (другие форматы отклоняются с сообщением об ошибке)
- Без ограничения размера файла
- **Без сжатия оригиналов** — хранятся как есть
- Прогресс загрузки (процентная шкала для каждого файла)
- **Автоповтор при ошибке сети**: 2-3 попытки автоматически
- Автоповорот по EXIF-ориентации
- Публикуются сразу (без модерации)
- **Без ограничения количества** фото на мероприятие

**Просмотр:**
- Миниатюры (превью) в таблице
- Клик → лайтбокс-галерея на весь экран с листанием
- Сортировка по дате загрузки

**Скачивание:**
- Скачивание отдельного фото (оригинал)
- Скачивание всех фото мероприятия ZIP-архивом
  - **Стриминг-архивация** (генерация на лету)
  - Без ограничения размера

**Удаление:**
- Кнопка удаления на каждом фото
- Диалог подтверждения "Вы уверены?"
- Реальное удаление (без soft delete)

### 3.2 Админ-панель

#### 3.2.1 Авторизация
- URL: `/admin`
- Отдельный пароль администратора

#### 3.2.2 Управление мероприятиями
- Редактирование **всех** полей мероприятия
- Добавление нового мероприятия вручную
- Удаление мероприятия (реальное удаление)
- Перемещение между месяцами/категориями

#### 3.2.3 Управление категориями
- Добавление новых категорий
- Редактирование названий категорий
- Удаление категорий (с мероприятиями или перенос)
- Изменение порядка категорий

#### 3.2.4 Импорт Excel
- Загрузка нового Excel-файла
- **Полная перезапись** всех данных (включая пояснения/ссылки)
- Фотографии **не удаляются**, но связь теряется
- Ручная привязка фото к мероприятиям после импорта
- Уведомление админу: "Привяжите фото к мероприятиям"

#### 3.2.5 Экспорт Excel
- Выгрузка всех данных в Excel-файл
- Формат аналогичен исходному (12 листов по месяцам)
- Фотографии: **URL-ссылки** в ячейках (через запятую)
- Колонки "Пояснение" и "Ссылки" заполнены из БД

#### 3.2.6 Настройки
- Изменение пароля публичной части
- Изменение пароля админки

---

## 4. Технический стек

### 4.1 Backend
- **Python 3.11+**
- **FastAPI** — REST API
- **SQLAlchemy** — ORM
- **Alembic** — миграции БД
- **Pillow** — обработка изображений (превью, EXIF)
- **openpyxl** — работа с Excel
- **python-multipart** — загрузка файлов

### 4.2 Frontend
- **React 18** + **TypeScript**
- **Vite** — сборка
- **React Router** — маршрутизация
- **Axios** — HTTP-клиент
- **Lightbox** библиотека (react-image-lightbox или аналог)
- Минималистичный CSS (без тяжёлых UI-фреймворков)
- **Только русский язык** интерфейса

### 4.3 База данных
- **PostgreSQL 15+**

### 4.4 Хранение файлов
- Локальная файловая система на сервере
- Структура: `/uploads/{year}/{month}/{event_id}/{filename}`
- Оригиналы (без сжатия) + превью (сжатые для веба)

### 4.5 Инфраструктура
- **Docker** + **docker-compose**
- **VPS/VDS** хостинг
- Внешний **Nginx Proxy Manager** (SSL/HTTPS)
- Внутренний **nginx** в Docker (HTTP, один порт)
- Доступное пространство: 50-200 ГБ
- **Бэкапы**: вне скоупа (настраиваются отдельно)

---

## 5. Архитектура

### 5.1 Схема деплоя

```
[Интернет]
    ↓ HTTPS
[Nginx Proxy Manager] (внешний, SSL)
    ↓ HTTP
[Docker: nginx:80]
    ↓
[Docker: FastAPI:8000]
    ↓
[Docker: PostgreSQL:5432]
```

### 5.2 Структура проекта

```
rksi_schedule_spo/
├── backend/
│   ├── app/
│   │   ├── main.py
│   │   ├── config.py
│   │   ├── models/
│   │   ├── schemas/
│   │   ├── api/
│   │   │   ├── auth.py
│   │   │   ├── events.py
│   │   │   ├── photos.py
│   │   │   └── admin.py
│   │   ├── services/
│   │   │   ├── excel_import.py
│   │   │   ├── excel_export.py
│   │   │   └── image_processor.py
│   │   └── utils/
│   ├── alembic/
│   ├── requirements.txt
│   └── Dockerfile
├── frontend/
│   ├── src/
│   │   ├── components/
│   │   ├── pages/
│   │   ├── api/
│   │   └── App.tsx
│   ├── package.json
│   └── Dockerfile
├── nginx/
│   └── nginx.conf
├── docker-compose.yml
└── .env.example
```

### 5.3 Модель данных

```
┌─────────────────────────────────────────────────────────┐
│ settings                                                │
├─────────────────────────────────────────────────────────┤
│ id: INT PK                                              │
│ key: VARCHAR(50) UNIQUE                                 │
│ value: TEXT                                             │
│ # keys: 'public_password', 'admin_password'             │
└─────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────┐
│ categories                                              │
├─────────────────────────────────────────────────────────┤
│ id: INT PK                                              │
│ name: VARCHAR(255)                                      │
│ month: INT (1-12)                                       │
│ sort_order: INT                                         │
└─────────────────────────────────────────────────────────┘
           │
           │ 1:N
           ▼
┌─────────────────────────────────────────────────────────┐
│ events                                                  │
├─────────────────────────────────────────────────────────┤
│ id: INT PK                                              │
│ category_id: INT FK                                     │
│ number: VARCHAR(20)     -- № п/п                        │
│ name: TEXT              -- Наименование                 │
│ event_date: VARCHAR(100)-- Дата проведения              │
│ responsible: TEXT       -- Ответственные                │
│ location: TEXT          -- Место проведения             │
│ description: TEXT       -- Пояснение (редактируемое)    │
│ sort_order: INT                                         │
│ created_at: TIMESTAMP                                   │
│ updated_at: TIMESTAMP                                   │
└─────────────────────────────────────────────────────────┘
           │
           │ 1:N
           ▼
┌─────────────────────────────────────────────────────────┐
│ event_links                                             │
├─────────────────────────────────────────────────────────┤
│ id: INT PK                                              │
│ event_id: INT FK                                        │
│ url: TEXT                                               │
│ created_at: TIMESTAMP                                   │
└─────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────┐
│ photos                                                  │
├─────────────────────────────────────────────────────────┤
│ id: INT PK                                              │
│ event_id: INT FK                                        │
│ filename: VARCHAR(255)                                  │
│ original_path: TEXT                                     │
│ thumbnail_path: TEXT                                    │
│ file_size: BIGINT                                       │
│ created_at: TIMESTAMP                                   │
└─────────────────────────────────────────────────────────┘
```

---

## 6. API Endpoints

### 6.1 Авторизация
```
POST /api/auth/login          -- вход (публичный пароль)
POST /api/auth/logout         -- выход
GET  /api/auth/check          -- проверка сессии
POST /api/admin/login         -- вход в админку
```

### 6.2 Мероприятия
```
GET  /api/events              -- список (query: month)
GET  /api/events/{id}         -- одно мероприятие
PATCH /api/events/{id}        -- обновить поля (description)
```

### 6.3 Ссылки
```
GET    /api/events/{id}/links     -- список ссылок
POST   /api/events/{id}/links     -- добавить ссылку
DELETE /api/links/{id}            -- удалить ссылку
```

### 6.4 Фотографии
```
GET    /api/events/{id}/photos    -- список фото
POST   /api/events/{id}/photos    -- загрузить фото (multipart)
DELETE /api/photos/{id}           -- удалить фото
GET    /api/events/{id}/photos/zip -- скачать ZIP
GET    /api/photos/{id}/original  -- скачать оригинал
```

### 6.5 Админка
```
GET    /api/admin/events          -- все мероприятия
POST   /api/admin/events          -- создать
PUT    /api/admin/events/{id}     -- полное редактирование
DELETE /api/admin/events/{id}     -- удалить

GET    /api/admin/categories      -- все категории
POST   /api/admin/categories      -- создать категорию
PUT    /api/admin/categories/{id} -- редактировать категорию
DELETE /api/admin/categories/{id} -- удалить категорию

POST   /api/admin/import          -- импорт Excel
GET    /api/admin/export          -- экспорт Excel
PUT    /api/admin/settings        -- изменить пароли
```

---

## 7. UI/UX требования

### 7.1 Общие принципы
- **Минималистичный** дизайн
- **Официальный стиль**: синие/серые тона, строгий и деловой
- Функциональность важнее визуальной красоты
- Понятный интерфейс для пользователей со **средним уровнем IT-грамотности**
- **Desktop-only** (мобильная версия не требуется)
- **Только светлая тема** (dark mode не нужен)
- **Базовая accessibility**: семантический HTML, alt-атрибуты, контрастные цвета

### 7.2 Страница входа
- Центрированная форма
- Поле пароля + кнопка "Войти"
- Сообщение об ошибке под полем

### 7.3 Главная страница
- Шапка с названием "План мероприятий СПО РО 2026"
- 12 табов-месяцев (горизонтально, с прокруткой если нужно)
- По умолчанию открыт текущий месяц
- Сворачиваемые категории (accordion)
- Подкатегории — визуальные разделители (выделенные строки)
- Таблица с фиксированной шапкой

### 7.4 Загрузка фото
- Зона drag & drop с пунктирной границей
- Текст "Перетащите файлы или нажмите для выбора"
- Прогресс-бар для каждого загружаемого файла
- Автоповтор при ошибке сети (2-3 попытки)
- Превью загруженных фото сразу появляются

### 7.5 Лайтбокс
- Фото на тёмном фоне
- Стрелки влево/вправо
- Кнопка скачивания
- Кнопка закрытия (X)
- Клик вне фото закрывает

### 7.6 Уведомления
- **Минимальные**: только об ошибках
- Сохранение происходит молча при успехе

---

## 8. Обработка изображений

### 8.1 При загрузке
1. Валидация формата (**только JPEG/PNG**, другие отклоняются)
2. Чтение EXIF-ориентации
3. Автоповорот согласно EXIF
4. Сохранение оригинала **без сжатия**
5. Создание превью (max 400x400, качество 85%)
6. Удаление EXIF из превью (экономия места)

### 8.2 Структура хранения
```
/uploads/
  /2026/
    /01/  (январь)
      /{event_id}/
        /original/
          photo1.jpg
          photo2.jpg
        /thumbnails/
          photo1.jpg
          photo2.jpg
```

---

## 9. Импорт/Экспорт Excel

### 9.1 Импорт
1. Загрузка файла через админку
2. Парсинг всех 12 листов
3. Определение категорий (строки-заголовки без № п/п)
4. Определение подкатегорий (строки с кодами типа "05.00.00")
5. Создание записей в БД
6. **Полная перезапись** всех данных (включая пояснения/ссылки)
7. Фото остаются, но привязка теряется
8. Уведомление админу: "Привяжите фото к мероприятиям"

### 9.2 Экспорт
1. Генерация Excel с 12 листами
2. Структура идентична исходному файлу
3. В колонке "Фотографии" — URL-ссылки на фото (через запятую)
4. Колонки "Пояснение" и "Ссылки" заполнены из БД

---

## 10. Безопасность

### 10.1 Аутентификация
- Пароли хранятся в БД в виде **bcrypt-хеша**
- JWT-токены для сессий (или httpOnly cookies)
- Срок жизни токена: 30 дней

### 10.2 Защита
- Rate limiting на login endpoints
- Валидация всех входных данных
- Санитизация имён файлов при загрузке
- CORS настроен для `events.labs-edu.ru` (через env)

---

## 11. Конфигурация

### 11.1 Переменные окружения (.env)
```env
# Database
POSTGRES_HOST=postgres
POSTGRES_PORT=5432
POSTGRES_USER=app
POSTGRES_PASSWORD=<secure_password>
POSTGRES_DB=events_portal

# Application
SECRET_KEY=<random_string_for_jwt>
UPLOAD_DIR=/app/uploads
MAX_UPLOAD_SIZE_MB=100
SITE_URL=https://events.labs-edu.ru

# Initial passwords (only for first run)
INITIAL_PUBLIC_PASSWORD=<initial_password>
INITIAL_ADMIN_PASSWORD=<initial_admin_password>
```

---

## 12. Docker Compose

```yaml
version: '3.8'

services:
  nginx:
    image: nginx:alpine
    ports:
      - "8080:80"  # внешний порт для Nginx Proxy Manager
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./uploads:/app/uploads:ro
      - frontend_build:/usr/share/nginx/html:ro
    depends_on:
      - backend

  backend:
    build: ./backend
    environment:
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
    volumes:
      - ./uploads:/app/uploads
    depends_on:
      - postgres

  postgres:
    image: postgres:15-alpine
    volumes:
      - postgres_data:/var/lib/postgresql/data
    environment:
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}

  frontend:
    build: ./frontend
    volumes:
      - frontend_build:/app/dist

volumes:
  postgres_data:
  frontend_build:
```

---

## 13. Риски и митигация

| Риск | Вероятность | Митигация |
|------|-------------|-----------|
| Сложность интерфейса | Средняя | Минималистичный дизайн, inline-редактирование, понятные подсказки |
| Потеря фото при импорте | Низкая | Фото не удаляются, только теряют привязку; уведомление админу |
| Большие файлы замедляют загрузку | Средняя | Превью для отображения, оригиналы только при скачивании |
| Случайное удаление фото | Средняя | Диалог подтверждения при удалении |
| Конфликт редактирования | Низкая | "Последний побеждает" — приемлемо для небольшого числа пользователей |
| Большие ZIP-архивы | Низкая | Стриминг-архивация, без ограничения размера |

---

## 14. Критерии готовности (Definition of Done)

- [ ] Авторизация по единому паролю работает
- [ ] Отображение мероприятий по месяцам (табы)
- [ ] По умолчанию открывается текущий месяц
- [ ] Группировка по категориям (сворачиваемые)
- [ ] Подкатегории как визуальные разделители
- [ ] Пустые месяцы показывают "Мероприятий нет"
- [ ] Редактирование поля "Пояснение" (клик → редактор)
- [ ] Добавление/удаление ссылок (только URL)
- [ ] Загрузка фото (drag & drop, мульти, прогресс)
- [ ] Автоповтор загрузки при ошибке сети
- [ ] Только JPEG/PNG (другие форматы отклоняются)
- [ ] Оригиналы хранятся без сжатия
- [ ] Просмотр фото (лайтбокс)
- [ ] Скачивание отдельных фото и ZIP (стриминг)
- [ ] Удаление фото (с подтверждением)
- [ ] Админка: `/admin` + отдельный пароль
- [ ] Админка: редактирование всех полей
- [ ] Админка: добавление/удаление мероприятий
- [ ] Админка: управление категориями
- [ ] Админка: импорт Excel (полная перезапись)
- [ ] Админка: экспорт Excel
- [ ] Админка: смена паролей
- [ ] Docker-деплой работает
- [ ] HTTPS через внешний proxy
- [ ] Официальный стиль (синие/серые тона)
- [ ] Уведомления только об ошибках

---

## 15. Уточнения из интервью (changelog)

### Добавлено:
- Домен: `events.labs-edu.ru`
- Месяц по умолчанию: текущий (автоопределение)
- Все 12 месяцев отображаются (включая пустые)
- Подкатегории — визуальные разделители (одноуровневая структура)
- Импорт из готового Excel (без перепарсинга DOCX)
- Конфликты редактирования: "последний побеждает"
- Без аудит-лога
- Только desktop (без мобильной версии)
- Оригиналы фото хранятся без сжатия
- Без поиска по мероприятиям
- Только JPEG/PNG (другие форматы отклоняются)
- URL админки: `/admin` (без секретного токена)
- Автоповтор загрузки при ошибке сети (2-3 попытки)
- ZIP генерируется на лету (стриминг)
- Ссылки: только URL, без валидации
- Редактирование пояснения: клик → редактор (inline)
- Полная перезапись при импорте Excel
- Ручное управление категориями в админке
- Без ограничения количества фото
- Официальный стиль дизайна (синие/серые)
- Без тёмной темы
- Только русский язык
- Без функции печати
- Уведомления только об ошибках
- Базовая accessibility
- VPS/VDS хостинг
- Бэкапы вне скоупа
