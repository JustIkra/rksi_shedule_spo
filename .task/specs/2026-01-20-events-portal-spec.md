# Спецификация: Портал плана мероприятий СПО Ростовской области

## 1. Обзор проекта

### 1.1 Назначение
Веб-приложение для отображения и редактирования плана мероприятий Совета директоров СПО Ростовской области на 2026 год. Позволяет просматривать мероприятия по месяцам, загружать фотографии, добавлять пояснения и ссылки на публикации.

### 1.2 Целевая аудитория
- **Пользователи**: сотрудники колледжей и техникумов Ростовской области (только внутренние)
- **Администратор**: 1 человек с полным доступом

### 1.3 Источник данных
Excel-файл `ПЛАН_РАБОТЫ_2026_по_месяцам_проверено_доп_поля.xlsx`:
- 12 листов (по месяцам: Январь — Декабрь)
- 8 колонок: № п/п, Наименование мероприятия, Дата проведения, Ответственные, Место проведения, Пояснение, Ссылки, Фотографии
- Категории мероприятий (Заседания Президиума, Олимпиады, Конкурсы и т.д.)

---

## 2. Модель доступа

### 2.1 Публичная часть (единый пароль)
- Вход по единому паролю для всех пользователей
- Сессия сохраняется **30 дней**
- Пароль меняется администратором через админ-панель

### 2.2 Права обычных пользователей (после ввода пароля)
- Просмотр всех мероприятий
- Редактирование 3 полей: **Пояснение**, **Ссылки**, **Фотографии**
- Загрузка фотографий
- Удаление любых фотографий (с диалогом подтверждения)
- Скачивание фотографий

### 2.3 Админ-панель
- Доступ: **скрытый URL** + **отдельный пароль**
- Полное редактирование всех полей мероприятий
- Добавление/удаление мероприятий
- Импорт Excel
- Экспорт в Excel
- Изменение пароля публичной части

---

## 3. Функциональные требования

### 3.1 Публичная часть

#### 3.1.1 Страница входа
- Поле ввода пароля
- Кнопка "Войти"
- Сообщение об ошибке при неверном пароле
- Запоминание сессии на 30 дней

#### 3.1.2 Главная страница (список мероприятий)
- **Навигация**: 12 табов сверху (Январь — Декабрь)
- **Группировка**: по категориям мероприятий (как в Excel)
- **Категории сворачиваемые**: можно скрыть/показать группу
- **Таблица мероприятий** с колонками:
  - № п/п
  - Наименование мероприятия
  - Дата проведения
  - Ответственные за подготовку
  - Место проведения
  - Пояснение (редактируемое)
  - Ссылки на материалы (редактируемое)
  - Фотографии (миниатюры + кнопка загрузки)

#### 3.1.3 Редактирование полей (inline)
- **Пояснение**: текстовое поле (textarea)
- **Ссылки**: неограниченное количество URL, добавление/удаление
- Автосохранение при потере фокуса или кнопка "Сохранить"

#### 3.1.4 Работа с фотографиями

**Загрузка:**
- Мультизагрузка (несколько файлов сразу)
- Drag & Drop + кнопка выбора файлов
- Форматы: JPEG, PNG
- Без ограничения размера файла
- Прогресс загрузки (процентная шкала для каждого файла)
- Ошибка + подсказка при неверном формате
- Автоповорот по EXIF-ориентации
- Публикуются сразу (без модерации)

**Просмотр:**
- Миниатюры (превью) в таблице
- Клик → лайтбокс-галерея на весь экран с листанием
- Сортировка по дате загрузки

**Скачивание:**
- Скачивание отдельного фото (оригинал)
- Скачивание всех фото мероприятия ZIP-архивом

**Удаление:**
- Кнопка удаления на каждом фото
- Диалог подтверждения "Вы уверены?"
- Реальное удаление (без soft delete)

### 3.2 Админ-панель

#### 3.2.1 Авторизация
- Скрытый URL (например, `/admin-{random_string}`)
- Отдельный пароль администратора

#### 3.2.2 Управление мероприятиями
- Редактирование **всех** полей мероприятия
- Добавление нового мероприятия вручную
- Удаление мероприятия (реальное удаление)
- Перемещение между месяцами/категориями

#### 3.2.3 Импорт Excel
- Загрузка нового Excel-файла
- **Перезапись** всех данных (кроме фото)
- Фотографии **не удаляются**, но связь теряется
- Ручная привязка фото к мероприятиям после импорта

#### 3.2.4 Экспорт Excel
- Выгрузка всех данных в Excel-файл
- Формат аналогичен исходному
- Фотографии: **URL-ссылки** в ячейках

#### 3.2.5 Настройки
- Изменение пароля публичной части
- Изменение пароля админки

---

## 4. Технический стек

### 4.1 Backend
- **Python 3.11+**
- **FastAPI** — REST API
- **SQLAlchemy** — ORM
- **Alembic** — миграции БД
- **Pillow** — обработка изображений (превью, EXIF)
- **openpyxl** — работа с Excel
- **python-multipart** — загрузка файлов

### 4.2 Frontend
- **React 18** + **TypeScript**
- **Vite** — сборка
- **React Router** — маршрутизация
- **Axios** — HTTP-клиент
- **Lightbox** библиотека (react-image-lightbox или аналог)
- Минималистичный CSS (без тяжёлых UI-фреймворков)

### 4.3 База данных
- **PostgreSQL 15+**

### 4.4 Хранение файлов
- Локальная файловая система на сервере
- Структура: `/uploads/{year}/{month}/{event_id}/{filename}`
- Оригиналы + превью (сжатые для веба)

### 4.5 Инфраструктура
- **Docker** + **docker-compose**
- Внешний **Nginx Proxy Manager** (SSL/HTTPS)
- Внутренний **nginx** в Docker (HTTP, один порт)
- Доступное пространство: 50-200 ГБ

---

## 5. Архитектура

### 5.1 Схема деплоя

```
[Интернет]
    ↓ HTTPS
[Nginx Proxy Manager] (внешний, SSL)
    ↓ HTTP
[Docker: nginx:80]
    ↓
[Docker: FastAPI:8000]
    ↓
[Docker: PostgreSQL:5432]
```

### 5.2 Структура проекта

```
rksi_schedule_spo/
├── backend/
│   ├── app/
│   │   ├── main.py
│   │   ├── config.py
│   │   ├── models/
│   │   ├── schemas/
│   │   ├── api/
│   │   │   ├── auth.py
│   │   │   ├── events.py
│   │   │   ├── photos.py
│   │   │   └── admin.py
│   │   ├── services/
│   │   │   ├── excel_import.py
│   │   │   ├── excel_export.py
│   │   │   └── image_processor.py
│   │   └── utils/
│   ├── alembic/
│   ├── requirements.txt
│   └── Dockerfile
├── frontend/
│   ├── src/
│   │   ├── components/
│   │   ├── pages/
│   │   ├── api/
│   │   └── App.tsx
│   ├── package.json
│   └── Dockerfile
├── nginx/
│   └── nginx.conf
├── docker-compose.yml
└── .env.example
```

### 5.3 Модель данных

```
┌─────────────────────────────────────────────────────────┐
│ settings                                                │
├─────────────────────────────────────────────────────────┤
│ id: INT PK                                              │
│ key: VARCHAR(50) UNIQUE                                 │
│ value: TEXT                                             │
│ # keys: 'public_password', 'admin_password',            │
│ #       'admin_url_token'                               │
└─────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────┐
│ categories                                              │
├─────────────────────────────────────────────────────────┤
│ id: INT PK                                              │
│ name: VARCHAR(255)                                      │
│ month: INT (1-12)                                       │
│ sort_order: INT                                         │
└─────────────────────────────────────────────────────────┘
           │
           │ 1:N
           ▼
┌─────────────────────────────────────────────────────────┐
│ events                                                  │
├─────────────────────────────────────────────────────────┤
│ id: INT PK                                              │
│ category_id: INT FK                                     │
│ number: VARCHAR(20)     -- № п/п                        │
│ name: TEXT              -- Наименование                 │
│ event_date: VARCHAR(100)-- Дата проведения              │
│ responsible: TEXT       -- Ответственные                │
│ location: TEXT          -- Место проведения             │
│ description: TEXT       -- Пояснение (редактируемое)    │
│ sort_order: INT                                         │
│ created_at: TIMESTAMP                                   │
│ updated_at: TIMESTAMP                                   │
└─────────────────────────────────────────────────────────┘
           │
           │ 1:N
           ▼
┌─────────────────────────────────────────────────────────┐
│ event_links                                             │
├─────────────────────────────────────────────────────────┤
│ id: INT PK                                              │
│ event_id: INT FK                                        │
│ url: TEXT                                               │
│ title: VARCHAR(255) NULLABLE                            │
│ created_at: TIMESTAMP                                   │
└─────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────┐
│ photos                                                  │
├─────────────────────────────────────────────────────────┤
│ id: INT PK                                              │
│ event_id: INT FK                                        │
│ filename: VARCHAR(255)                                  │
│ original_path: TEXT                                     │
│ thumbnail_path: TEXT                                    │
│ file_size: BIGINT                                       │
│ created_at: TIMESTAMP                                   │
└─────────────────────────────────────────────────────────┘
```

---

## 6. API Endpoints

### 6.1 Авторизация
```
POST /api/auth/login          -- вход (публичный пароль)
POST /api/auth/logout         -- выход
GET  /api/auth/check          -- проверка сессии
POST /api/admin/login         -- вход в админку
```

### 6.2 Мероприятия
```
GET  /api/events              -- список (query: month)
GET  /api/events/{id}         -- одно мероприятие
PATCH /api/events/{id}        -- обновить поля (description)
```

### 6.3 Ссылки
```
GET    /api/events/{id}/links     -- список ссылок
POST   /api/events/{id}/links     -- добавить ссылку
DELETE /api/links/{id}            -- удалить ссылку
```

### 6.4 Фотографии
```
GET    /api/events/{id}/photos    -- список фото
POST   /api/events/{id}/photos    -- загрузить фото (multipart)
DELETE /api/photos/{id}           -- удалить фото
GET    /api/events/{id}/photos/zip -- скачать ZIP
GET    /api/photos/{id}/original  -- скачать оригинал
```

### 6.5 Админка
```
GET    /api/admin/events          -- все мероприятия
POST   /api/admin/events          -- создать
PUT    /api/admin/events/{id}     -- полное редактирование
DELETE /api/admin/events/{id}     -- удалить
POST   /api/admin/import          -- импорт Excel
GET    /api/admin/export          -- экспорт Excel
PUT    /api/admin/settings        -- изменить пароли
```

---

## 7. UI/UX требования

### 7.1 Общие принципы
- **Минималистичный** дизайн
- Функциональность важнее визуальной красоты
- Понятный интерфейс для пользователей со **средним уровнем IT-грамотности**
- **Desktop-first** (загрузка только с ПК)

### 7.2 Страница входа
- Центрированная форма
- Поле пароля + кнопка "Войти"
- Сообщение об ошибке под полем

### 7.3 Главная страница
- Шапка с названием "План мероприятий СПО РО 2026"
- 12 табов-месяцев (горизонтально, с прокруткой если нужно)
- Сворачиваемые категории (accordion)
- Таблица с фиксированной шапкой

### 7.4 Загрузка фото
- Зона drag & drop с пунктирной границей
- Текст "Перетащите файлы или нажмите для выбора"
- Прогресс-бар для каждого загружаемого файла
- Превью загруженных фото сразу появляются

### 7.5 Лайтбокс
- Фото на тёмном фоне
- Стрелки влево/вправо
- Кнопка скачивания
- Кнопка закрытия (X)
- Клик вне фото закрывает

---

## 8. Обработка изображений

### 8.1 При загрузке
1. Валидация формата (только JPEG/PNG)
2. Чтение EXIF-ориентации
3. Автоповорот согласно EXIF
4. Сохранение оригинала
5. Создание превью (max 400x400, качество 85%)
6. Удаление EXIF из превью (экономия места)

### 8.2 Структура хранения
```
/uploads/
  /2026/
    /01/  (январь)
      /{event_id}/
        /original/
          photo1.jpg
          photo2.jpg
        /thumbnails/
          photo1.jpg
          photo2.jpg
```

---

## 9. Импорт/Экспорт Excel

### 9.1 Импорт
1. Загрузка файла через админку
2. Парсинг всех 12 листов
3. Определение категорий (строки-заголовки без № п/п)
4. Создание записей в БД
5. **Полная перезапись** данных (кроме фото)
6. Фото остаются, но привязка теряется
7. Уведомление админу: "Привяжите фото к мероприятиям"

### 9.2 Экспорт
1. Генерация Excel с 12 листами
2. Структура идентична исходному файлу
3. В колонке "Фотографии" — URL-ссылки на фото (через запятую)
4. Колонки "Пояснение" и "Ссылки" заполнены из БД

---

## 10. Безопасность

### 10.1 Аутентификация
- Пароли хранятся в БД в виде **bcrypt-хеша**
- JWT-токены для сессий (или httpOnly cookies)
- Срок жизни токена: 30 дней

### 10.2 Защита
- Rate limiting на login endpoints
- Валидация всех входных данных
- Санитизация имён файлов при загрузке
- CORS настроен только для своего домена

---

## 11. Конфигурация

### 11.1 Переменные окружения (.env)
```env
# Database
POSTGRES_HOST=postgres
POSTGRES_PORT=5432
POSTGRES_USER=app
POSTGRES_PASSWORD=<secure_password>
POSTGRES_DB=events_portal

# Application
SECRET_KEY=<random_string_for_jwt>
UPLOAD_DIR=/app/uploads
MAX_UPLOAD_SIZE_MB=100

# Initial passwords (only for first run)
INITIAL_PUBLIC_PASSWORD=<initial_password>
INITIAL_ADMIN_PASSWORD=<initial_admin_password>
ADMIN_URL_TOKEN=<random_string>
```

---

## 12. Docker Compose

```yaml
version: '3.8'

services:
  nginx:
    image: nginx:alpine
    ports:
      - "8080:80"  # внешний порт для Nginx Proxy Manager
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./uploads:/app/uploads:ro
      - frontend_build:/usr/share/nginx/html:ro
    depends_on:
      - backend

  backend:
    build: ./backend
    environment:
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
    volumes:
      - ./uploads:/app/uploads
    depends_on:
      - postgres

  postgres:
    image: postgres:15-alpine
    volumes:
      - postgres_data:/var/lib/postgresql/data
    environment:
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}

  frontend:
    build: ./frontend
    volumes:
      - frontend_build:/app/dist

volumes:
  postgres_data:
  frontend_build:
```

---

## 13. Риски и митигация

| Риск | Вероятность | Митигация |
|------|-------------|-----------|
| Сложность интерфейса | Средняя | Минималистичный дизайн, inline-редактирование, понятные подсказки |
| Потеря фото при импорте | Низкая | Фото не удаляются, только теряют привязку; уведомление админу |
| Большие файлы замедляют загрузку | Средняя | Превью для отображения, оригиналы только при скачивании |
| Случайное удаление фото | Средняя | Диалог подтверждения при удалении |

---

## 14. Критерии готовности (Definition of Done)

- [ ] Авторизация по единому паролю работает
- [ ] Отображение мероприятий по месяцам (табы)
- [ ] Группировка по категориям (сворачиваемые)
- [ ] Редактирование поля "Пояснение"
- [ ] Добавление/удаление ссылок
- [ ] Загрузка фото (drag & drop, мульти, прогресс)
- [ ] Просмотр фото (лайтбокс)
- [ ] Скачивание отдельных фото и ZIP
- [ ] Удаление фото (с подтверждением)
- [ ] Админка: редактирование всех полей
- [ ] Админка: добавление/удаление мероприятий
- [ ] Админка: импорт Excel
- [ ] Админка: экспорт Excel
- [ ] Админка: смена паролей
- [ ] Docker-деплой работает
- [ ] HTTPS через внешний proxy
